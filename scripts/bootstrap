#!/usr/bin/env bash
set -euo pipefail

# Bootstrap script for self-hosting CRM
# Generates secrets, configures environment, and starts the Docker stack

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
cd "$PROJECT_ROOT"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default values
APP_ENV="${APP_ENV:-production}"
APP_PORT="${APP_PORT:-5000}"
DB_NAME="${DB_NAME:-crm}"
DB_USER="${DB_USER:-crm_user}"
ENABLE_REDIS="${ENABLE_REDIS:-true}"
ENABLE_SMTP="${ENABLE_SMTP:-false}"
STORAGE_MODE="${STORAGE_MODE:-local}"
SYNC_GITHUB_SECRETS="${SYNC_GITHUB_SECRETS:-false}"

# Function to print colored messages
log_info() { echo -e "${BLUE}â„¹${NC} $1"; }
log_success() { echo -e "${GREEN}âœ“${NC} $1"; }
log_warn() { echo -e "${YELLOW}âš ${NC} $1"; }
log_error() { echo -e "${RED}âœ—${NC} $1"; }

# Function to generate cryptographically strong secret
generate_secret() {
  local length="${1:-32}"
  openssl rand -hex "$length"
}

# Function to prompt for input with default
prompt() {
  local var_name="$1"
  local prompt_text="$2"
  local default_value="$3"
  local current_value

  if [ -n "${!var_name:-}" ]; then
    # Value already set via flag or env
    return
  fi

  if [ -n "$default_value" ]; then
    read -p "$prompt_text [$default_value]: " current_value
    eval "$var_name=\"${current_value:-$default_value}\""
  else
    read -p "$prompt_text: " current_value
    eval "$var_name=\"$current_value\""
  fi
}

# Function to check prerequisites
check_prerequisites() {
  log_info "Checking prerequisites..."
  
  if ! command -v docker &> /dev/null; then
    log_error "Docker is not installed. Please install Docker Engine first."
    exit 1
  fi
  
  if ! docker compose version &> /dev/null; then
    log_error "Docker Compose plugin is not installed."
    exit 1
  fi
  
  if [ "$SYNC_GITHUB_SECRETS" = "true" ] && ! command -v gh &> /dev/null; then
    log_warn "GitHub CLI (gh) not found. GitHub secrets sync will be skipped."
    SYNC_GITHUB_SECRETS="false"
  fi
  
  log_success "Prerequisites check passed"
}

# Function to backup existing .env
backup_env() {
  if [ -f ".env" ]; then
    local backup_file=".env.backup.$(date +%Y%m%d_%H%M%S)"
    cp .env "$backup_file"
    log_success "Backed up existing .env to $backup_file"
  fi
}

# Function to generate all secrets
generate_secrets() {
  log_info "Generating cryptographic secrets..."
  
  # Application secrets
  SESSION_SECRET="$(generate_secret 32)"
  JWT_SECRET="$(generate_secret 32)"
  WEBHOOK_SECRET="$(generate_secret 32)"
  SERVICE_API_TOKEN="$(generate_secret 32)"
  SSO_IMPERSONATION_SECRET="$(generate_secret 32)"
  
  # Database password
  PGPASSWORD="$(generate_secret 24)"
  
  # Redis password (if enabled)
  if [ "$ENABLE_REDIS" = "true" ]; then
    REDIS_PASSWORD="$(generate_secret 24)"
  fi
  
  log_success "Secrets generated"
}

# Function to compute derived URLs
compute_urls() {
  log_info "Computing connection URLs..."
  
  # Database URL
  PGHOST="${PGHOST:-postgres}"
  PGPORT="${PGPORT:-5432}"
  DATABASE_URL="postgresql://${DB_USER}:${PGPASSWORD}@${PGHOST}:${PGPORT}/${DB_NAME}?sslmode=disable"
  
  # Redis URL (if enabled)
  if [ "$ENABLE_REDIS" = "true" ]; then
    REDIS_HOST="${REDIS_HOST:-redis}"
    REDIS_PORT="${REDIS_PORT:-6379}"
    REDIS_URL="redis://:${REDIS_PASSWORD}@${REDIS_HOST}:${REDIS_PORT}/0"
  fi
  
  # Public URL
  if [ -n "${DOMAIN:-}" ]; then
    PUBLIC_URL="https://${DOMAIN}"
  else
    PUBLIC_URL="http://localhost:${APP_PORT}"
  fi
  
  log_success "URLs computed"
}

# Function to write .env file
write_env_file() {
  log_info "Writing .env file..."
  
  cat > .env << EOF
# Generated by bootstrap script on $(date)
# DO NOT COMMIT THIS FILE

# Application
NODE_ENV=${APP_ENV}
PORT=${APP_PORT}
PUBLIC_URL=${PUBLIC_URL}

# Database
DATABASE_URL=${DATABASE_URL}
PGHOST=${PGHOST}
PGPORT=${PGPORT}
PGDATABASE=${DB_NAME}
PGUSER=${DB_USER}
PGPASSWORD=${PGPASSWORD}

# Redis (Session Store)
EOF

  if [ "$ENABLE_REDIS" = "true" ]; then
    cat >> .env << EOF
REDIS_URL=${REDIS_URL}
REDIS_PASSWORD=${REDIS_PASSWORD}
EOF
  else
    cat >> .env << EOF
# REDIS_URL=
# REDIS_PASSWORD=
EOF
  fi

  cat >> .env << EOF

# Secrets
SESSION_SECRET=${SESSION_SECRET}
JWT_SECRET=${JWT_SECRET}
WEBHOOK_SECRET=${WEBHOOK_SECRET}
SERVICE_API_TOKEN=${SERVICE_API_TOKEN}
SSO_IMPERSONATION_SECRET=${SSO_IMPERSONATION_SECRET}

# External Services
TWELVEDATA_API_KEY=${TWELVEDATA_API_KEY:-}
TWELVEDATA_WS_URL=wss://ws.twelvedata.com/v1/quotes/price
TWELVEDATA_REST_URL=https://api.twelvedata.com
TRADING_PLATFORM_URL=${TRADING_PLATFORM_URL:-}

# Caddy
DOMAIN=${DOMAIN:-localhost}
EOF

  if [ -n "${ADMIN_AUTH_USER:-}" ]; then
    cat >> .env << EOF
ADMIN_AUTH_USER=${ADMIN_AUTH_USER}
ADMIN_AUTH_PASS_HASH=${ADMIN_AUTH_PASS_HASH}
EOF
  fi

  log_success ".env file written (no secrets printed)"
}

# Function to render Caddyfile
render_caddyfile() {
  if [ -n "${DOMAIN:-}" ] && [ "$DOMAIN" != "localhost" ]; then
    log_info "Rendering Caddyfile with HTTPS for domain: $DOMAIN"
    
    cat > Caddyfile << EOF
${DOMAIN} {
    # Automatic HTTPS with Let's Encrypt
    tls ${ACME_EMAIL:-}
    
    # Health check endpoints
    handle /health/* {
        reverse_proxy app:5000
    }
    
    # API and WebSocket
    handle /api/* {
        reverse_proxy app:5000
    }
    
    handle /ws {
        reverse_proxy app:5000
    }
    
    # Frontend
    handle {
        reverse_proxy app:5000
    }
    
    # Proxy headers
    header {
        X-Real-IP {remote_host}
        X-Forwarded-For {remote_host}
        X-Forwarded-Proto {scheme}
        X-Forwarded-Host {host}
    }
    
    # Logging
    log {
        output stdout
        format json
    }
}

# HTTP redirect to HTTPS
http://${DOMAIN} {
    redir https://{host}{uri} permanent
}
EOF
    log_success "Caddyfile configured for HTTPS"
  else
    log_info "Using default Caddyfile (HTTP only)"
  fi
}

# Function to start Docker stack
start_stack() {
  log_info "Starting Docker Compose stack..."
  
  # Start with or without Redis based on ENABLE_REDIS
  if [ "$ENABLE_REDIS" = "true" ]; then
    log_info "Starting with Redis..."
    docker compose --profile redis up -d --build
  else
    log_info "Starting without Redis..."
    docker compose up -d --build
  fi
  
  log_info "Waiting for services to become healthy..."
  local max_wait=120
  local waited=0
  
  while [ $waited -lt $max_wait ]; do
    if docker compose ps | grep -q "healthy"; then
      log_success "Services are healthy"
      return 0
    fi
    sleep 2
    waited=$((waited + 2))
    echo -n "."
  done
  
  log_error "Services did not become healthy within ${max_wait}s"
  docker compose logs --tail=50
  return 1
}

# Function to run migrations
run_migrations() {
  log_info "Running database migrations..."
  
  docker compose exec -T app npx drizzle-kit push || {
    log_error "Migrations failed"
    return 1
  }
  
  log_success "Migrations completed"
}

# Function to run seed
run_seed() {
  log_info "Running database seed (idempotent)..."
  
  docker compose exec -T app node -e "
    import('./dist/seed.js').then(() => {
      console.log('Seed completed');
      process.exit(0);
    }).catch(err => {
      console.error('Seed failed:', err);
      process.exit(1);
    });
  " || log_warn "Seed may have already run"
  
  log_success "Seed step completed"
}

# Function to register webhooks
register_webhooks() {
  log_info "Registering webhook endpoints..."
  
  # In this system, webhooks are configured via environment variables
  # and used by the application at runtime. No DB registration needed.
  
  log_success "Webhook configuration ready"
}

# Function to sync to GitHub secrets
sync_github_secrets() {
  if [ "$SYNC_GITHUB_SECRETS" != "true" ] || [ -z "${GITHUB_REPO:-}" ]; then
    return 0
  fi
  
  log_info "Syncing secrets to GitHub Actions..."
  
  # Secrets to sync (exclude server-only vars like PGHOST)
  gh secret set SESSION_SECRET -b"$SESSION_SECRET" -R "$GITHUB_REPO"
  gh secret set JWT_SECRET -b"$JWT_SECRET" -R "$GITHUB_REPO"
  gh secret set WEBHOOK_SECRET -b"$WEBHOOK_SECRET" -R "$GITHUB_REPO"
  gh secret set SERVICE_API_TOKEN -b"$SERVICE_API_TOKEN" -R "$GITHUB_REPO"
  
  log_success "GitHub secrets synced"
}

# Function to display success message
display_success() {
  echo ""
  log_success "Bootstrap completed successfully!"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "  ğŸŒ Your CRM is now running at: ${GREEN}${PUBLIC_URL}${NC}"
  echo ""
  echo "  ğŸ“Š Admin credentials: See .env file or run seed script output"
  echo "  ğŸ“ View logs: ${BLUE}docker compose logs -f${NC}"
  echo "  ğŸ” Check health: ${BLUE}curl ${PUBLIC_URL}/health/ready${NC}"
  echo ""
  echo "  To rollback: Restore from .env.backup.* file"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
}

# Main execution
main() {
  echo ""
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo "  CRM Self-Hosting Bootstrap"
  echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  echo ""
  
  # Check prerequisites
  check_prerequisites
  
  # Interactive mode (if flags not provided)
  if [ "${1:-}" != "--non-interactive" ]; then
    log_info "Starting interactive configuration..."
    echo ""
    
    prompt DOMAIN "Domain name (leave empty for localhost)" ""
    
    if [ -n "$DOMAIN" ] && [ "$DOMAIN" != "localhost" ]; then
      prompt ACME_EMAIL "Email for Let's Encrypt certificates" ""
    fi
    
    prompt DB_NAME "Database name" "$DB_NAME"
    prompt DB_USER "Database user" "$DB_USER"
    
    read -p "Enable Redis for sessions? (y/n) [y]: " redis_choice
    ENABLE_REDIS="${redis_choice:-y}"
    [ "$ENABLE_REDIS" = "y" ] && ENABLE_REDIS="true" || ENABLE_REDIS="false"
    
    read -p "Sync secrets to GitHub Actions? (y/n) [n]: " github_choice
    SYNC_GITHUB_SECRETS="${github_choice:-n}"
    if [ "$SYNC_GITHUB_SECRETS" = "y" ]; then
      SYNC_GITHUB_SECRETS="true"
      prompt GITHUB_REPO "GitHub repository (owner/repo)" ""
    else
      SYNC_GITHUB_SECRETS="false"
    fi
    
    prompt TWELVEDATA_API_KEY "Twelve Data API key (optional)" ""
    prompt TRADING_PLATFORM_URL "Trading Platform URL (optional)" ""
    
    echo ""
  fi
  
  # Backup existing .env
  backup_env
  
  # Generate secrets
  generate_secrets
  
  # Compute URLs
  compute_urls
  
  # Write .env file
  write_env_file
  
  # Render Caddyfile
  render_caddyfile
  
  # Start Docker stack
  start_stack
  
  # Run migrations
  run_migrations
  
  # Run seed
  run_seed
  
  # Register webhooks
  register_webhooks
  
  # Sync GitHub secrets
  sync_github_secrets
  
  # Display success
  display_success
}

# Run main
main "$@"
