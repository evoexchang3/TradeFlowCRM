#!/bin/bash
set -e

echo "ğŸ” Running health checks..."
echo ""

# Container status
echo "ğŸ“¦ Containers:"
docker compose ps --format "table {{.Service}}\t{{.Status}}\t{{.Health}}"
echo ""

# Health endpoints
echo "ğŸ¥ Health endpoints:"
echo -n "  Liveness: "
curl -sf http://localhost/health/live > /dev/null && echo "âœ… OK" || echo "âŒ FAIL"
echo -n "  Readiness: "
curl -sf http://localhost/health/ready > /dev/null && echo "âœ… OK" || echo "âŒ FAIL"
echo ""

# Database
echo "ğŸ’¾ Database:"
docker compose exec -T postgres psql -U ${PGUSER:-crm_user} -d ${PGDATABASE:-crm} -c "SELECT 1;" > /dev/null 2>&1 && echo "  âœ… Connected" || echo "  âŒ Failed"
echo ""

# Redis
if [ -n "${REDIS_PASSWORD:-}" ]; then
  echo "ğŸ“¦ Redis:"
  docker compose exec -T redis redis-cli --pass "$REDIS_PASSWORD" PING > /dev/null 2>&1 && echo "  âœ… Connected" || echo "  âŒ Failed"
  echo ""
fi

echo "âœ… Health check complete"
